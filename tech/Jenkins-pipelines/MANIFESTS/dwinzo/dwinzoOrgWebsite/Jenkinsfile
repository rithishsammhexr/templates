pipeline {
    agent {
        label 'remote-server-agent'
    }
    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'ref', value: '$.ref'],
                [key: 'commit', value: '$.after'],
                [key: 'author', value: '$.commits[0].author.name']
            ],
            causeString: 'Triggered by commit on $ref by $author',
            token: 'dwinzoBetaWebsite',
            printContributedVariables: true,
            printPostContent: true,
            regexpFilterText: '$ref',
            regexpFilterExpression: '^refs/heads/main$'
        )
    }
    environment {
        GIT_CREDENTIALS = credentials('ramkumarp')
        DOCKER_COMPOSE = 'docker-compose'
        APP_NAME = 'Vishnu/dwinzo-website'
        MAIN_CONTAINER = 'dwinzo-react-vite'
        SONAR_HOST_URL = 'http://185.100.212.76:12345'
        SONAR_TOKEN = credentials('sonarqube-token')
        SMTP_CREDENTIALS = credentials('smtp-credentials-gmail')
        WEBSITE_URL = 'http://185.100.212.76:4040'
    }
    stages {
        stage('Source') {
            steps {
                cleanWs(deleteDirs: true, disableDeferredWipeout: true)
                script {
                    powershell '''
                        Write-Host "Starting source stage..."
                    '''
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[
                            url: 'http://185.100.212.76:7776/Vishnu/dwinzo-website.git',
                            credentialsId: env.GIT_CREDENTIALS
                        ]]
                    ])
                    powershell '''
                        Write-Host "Source checkout completed successfully"
                        Get-ChildItem
                    '''
                }
            }
        }
        stage('Build') {
            steps {
                script {
                    powershell '''
                        Write-Host "Cleaning existing Docker resources..."
                        # Stop and remove existing container if any
                        $containerExists = docker ps -a -q -f "name=$env:MAIN_CONTAINER"
                        if ($containerExists) {
                            Write-Host "Removing container: $env:MAIN_CONTAINER"
                            docker stop $env:MAIN_CONTAINER | Out-Null
                            docker rm -f $env:MAIN_CONTAINER | Out-Null
                        } else {
                            Write-Host "No existing container found."
                        }
                        # Prune unused images
                        docker image prune -af | Out-Null
                        # Build using compose
                        Write-Host "Starting Docker Compose build..."
                        $env:COMPOSE_CONVERT_WINDOWS_PATHS=1
                        docker-compose build --no-cache
                    '''
                }
            }
        }
        stage('SonarQube Analysis') {
            steps {
                script {
                    powershell '''
                        Write-Host "Checking project structure..."
                        Write-Host "Current directory contents:"
                        Get-ChildItem -Name
                        Write-Host "Looking for source directories..."
                        $sourceDirs = @()
                        # Check common React/Vite source directories
                        if (Test-Path "./src") {
                            $sourceDirs += "./src"
                            Write-Host "Found: ./src"
                        }
                        if (Test-Path "./app") {
                            $sourceDirs += "./app"
                            Write-Host "Found: ./app"
                        }
                        if (Test-Path "./components") {
                            $sourceDirs += "./components"
                            Write-Host "Found: ./components"
                        }
                        if (Test-Path "./pages") {
                            $sourceDirs += "./pages"
                            Write-Host "Found: ./pages"
                        }
                        # If no specific source dirs found, use current directory but exclude common folders
                        if ($sourceDirs.Count -eq 0) {
                            $sourceDirs += "."
                            Write-Host "No specific source directories found, using current directory"
                        }
                        $sourceString = $sourceDirs -join ","
                        Write-Host "Using sources: $sourceString"
                        Write-Host "Generating sonar-project.properties for Dwinzo Website..."
                        $sonarProps = @"
sonar.projectKey=Dwinzo_Beta_Website
sonar.projectName=Dwinzo_Beta_Website
sonar.projectVersion=1.0.0
sonar.projectDescription=Dwinzo Website - React/Vite Frontend Application
sonar.sources=$sourceString
sonar.language=js
sonar.javascript.lcov.reportPaths=coverage/lcov.info
sonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/public/**,**/*.min.js,**/vendor/**,**/coverage/**
"@
                        Set-Content -Path "sonar-project.properties" -Value $sonarProps
                        Write-Host "Generated sonar-project.properties:"
                        Get-Content "sonar-project.properties"
                        Write-Host "Running SonarScanner for Dwinzo Website..."
                        sonar-scanner
                    '''
                }
            }
        }
        stage('Deploy') {
            steps {
                script {
                    powershell '''
                        Write-Host "Starting deployment with Docker Compose..."
                        $env:COMPOSE_CONVERT_WINDOWS_PATHS=1
                        docker-compose up -d
                        Start-Sleep -Seconds 10
                        $mainContainer = docker ps -q -f "name=$env:MAIN_CONTAINER"
                        if (-not $mainContainer) {
                            Write-Error "Main application container ($env:MAIN_CONTAINER) not found"
                            exit 1
                        }
                        Write-Host "Application deployed successfully!"
                        Write-Host "Main Container ID: $mainContainer"
                        Write-Host "Main Container Logs:"
                        docker logs $mainContainer
                        Write-Host "Currently running containers:"
                        docker ps
                    '''
                }
            }
        }
    }
       post {
        always {
            script {
                emailext(
                    subject: "üöÄ Dwinzo Website - Build ${env.BUILD_NUMBER} | ${currentBuild.result ?: 'SUCCESS'}",
                    body: """
                      <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Dwinzo Deployment Report</title>
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; }
                                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background-color: #f8fafc; padding: 20px; }
                                .container { max-width: 700px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
                                .header { background: linear-gradient(135deg, #f8bbd9 0%, #ddd6fe 50%, #e9d5ff 100%); padding: 35px 25px; text-align: center; color: #4a5568; position: relative; overflow: hidden; }
                                .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
                                .website-tag { background: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 15px; font-size: 11px; color: #553c9a; font-weight: 600; white-space: nowrap; }
                                .header-content { flex: 1; text-align: center; }
                                .logo { background: rgba(255,255,255,0.8); display: inline-block; padding: 15px 22px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.3); }
                                .logo-text { font-size: 20px; font-weight: 700; letter-spacing: 1px; color: #553c9a; }
                                .logo-subtitle { font-size: 11px; opacity: 0.8; margin-top: 4px; color: #6b46c1; }
                                .header-title { font-size: 24px; font-weight: 600; margin-bottom: 6px; color: #553c9a; }
                                .header-subtitle { font-size: 14px; opacity: 0.8; color: #6b46c1; }
                                .status-badge { display: inline-block; padding: 8px 20px; border-radius: 25px; font-weight: 600; font-size: 14px; margin: 15px 0; }
                                .success { background: #10b981; color: white; }
                                .failure { background: #ef4444; color: white; }
                                .warning { background: #f59e0b; color: white; }
                                .content { padding: 40px 30px; }
                                .greeting { font-size: 18px; color: #1f2937; margin-bottom: 20px; }
                                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
                                .info-card { background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea; }
                                .info-label { font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
                                .info-value { font-size: 16px; color: #1f2937; font-weight: 500; }
                                .details-section { background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #f3e8ff 100%); padding: 25px; border-radius: 12px; margin: 30px 0; border: 1px solid #f8d7da; }
                                .details-title { font-size: 18px; color: #553c9a; font-weight: 600; margin-bottom: 20px; text-align: center; }
                                .details-table { width: 100%; border-collapse: collapse; }
                                .details-table th { background: rgba(255,255,255,0.8); padding: 12px 15px; text-align: left; font-weight: 600; color: #553c9a; border-bottom: 2px solid #e9d5ff; }
                                .details-table td { padding: 12px 15px; border-bottom: 1px solid #f8bbd9; color: #4a5568; }
                                .actions { text-align: center; margin: 30px 0; }
                                .btn { display: inline-block; padding: 12px 25px; margin: 8px 10px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; }
                                .btn-primary { background: #f8fafc; color: #4a5568; border: 1px solid #e2e8f0; }
                                .btn-secondary { background: #f1f5f9; color: #475569; border: 1px solid #d1d5db; }
                                .btn-success { background: #10b981; color: white; }
                                .footer { background: #fdf7ff; padding: 30px; text-align: center; border-top: 1px solid #f3e8ff; }
                                .footer-content { color: #7c3aed; font-size: 14px; line-height: 1.6; }
                                .company-info { margin-top: 20px; padding-top: 20px; border-top: 1px solid #f3e8ff; }
                                .highlight { background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #f3e8ff 100%); padding: 25px; border-radius: 16px; margin: 25px 0; border: 1px solid #f8d7da; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.1); }
                                .notes-section { background: #fef7ff; padding: 25px; border-radius: 16px; border-left: 5px solid #c084fc; margin-top: 30px; box-shadow: 0 2px 10px rgba(192, 132, 252, 0.1); }
                                .notes-section ul { margin-top: 10px; padding-left: 20px; color: #1e40af; }
                                .notes-section li { margin-bottom: 5px; }
                                .product-manager { color: #7c3aed; margin-bottom: 10px; }
                                .product-manager .name { font-weight: bold; }
                                a { color: #7c3aed !important; text-decoration: none !important; }
                                .btn:link, .btn:visited { text-decoration: none !important; }
                                .btn-primary:link, .btn-primary:visited { color: #4a5568 !important; }
                                .btn-secondary:link, .btn-secondary:visited { color: #475569 !important; }
                                .btn-success:link, .btn-success:visited { color: white !important; }
                                @media (max-width: 600px) {
                                    .container { margin: 0 10px; }
                                    .info-grid { grid-template-columns: 1fr; }
                                    .btn { display: block; margin: 10px auto; width: 200px; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <!-- Header Section -->
                                <div class="header">
                                   <div class="header-top">
                                    <div></div>
                                    <div class="website-tag">
                                        <a href="http://185.100.212.76:4040/" target="_blank" style="text-decoration: none; color: inherit;">
                                            dwinzo.com
                                        </a>
                                    </div>
                                </div>
                                    <div class="header-content">
                                        <div class="logo">
                                            <div class="logo-text">DWINZO</div>
                                            <div class="logo-subtitle">Beta Platform</div>
                                        </div>
                                        <div class="header-title">üöÄ Deployment Report</div>
                                        <div class="header-subtitle">Build #127 ‚Ä¢ Jun 18, 2025 ‚Ä¢ 14:32:15</div>
                                        <div class="status-badge success">
                                            SUCCESS
                                        </div>
                                    </div>
                                </div>
                        
                                <!-- Main Content -->
                                <div class="content">
                                    <div class="greeting">
                                        üëã Hello Development Team,
                                    </div>
                                    
                                    <p>Your latest deployment has been processed successfully. Here's a comprehensive overview of the build and deployment status.</p>
                        
                                    <!-- Quick Info Grid -->
                                    <div class="info-grid">
                                        <div class="info-card">
                                            <div class="info-label">Repository</div>
                                            <div class="info-value">Vishnu/dwinzo-website</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-label">Triggered By</div>
                                            <div class="info-value">Gitea</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-label">Branch</div>
                                            <div class="info-value">main</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-label">Duration</div>
                                            <div class="info-value">1m 42s</div>
                                        </div>
                                    </div>
                        
                                    <!-- Highlight Section -->
                                    <div class="highlight">
                                        <strong>üéØ Deployment Summary:</strong><br>
                                        The Dwinzo Beta Website has been successfully deployed and is now live. All containers are running optimally, and quality checks have passed.
                                    </div>
                        
                                    <!-- Detailed Information -->
                                    <div class="details-section">
                                        <div class="details-title">üìä Build Details</div>
                                        <table class="details-table">
                                            <thead>
                                                <tr>
                                                    <th>Component</th>
                                                    <th>Details</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><strong>Application Name</strong></td>
                                                    <td>Vishnu/dwinzo-website</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Main Container</strong></td>
                                                    <td>dwinzo-react-vite</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Build Status</strong></td>
                                                    <td><span class="status-badge success">SUCCESS</span></td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Deployment Time</strong></td>
                                                    <td>Jun 18, 2025 14:32:15 IST</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Website URL</strong></td>
                                                    <td><a href="http://185.100.212.76:4040" style="color: #667eea; text-decoration: none;">http://185.100.212.76:4040</a></td>
                                                </tr>
                                                <tr>
                                                    <td><strong>SonarQube Analysis</strong></td>
                                                    <td><a href="http://185.100.212.76:12345/dashboard?id=Dwinzo_Beta_Website" style="color: #667eea; text-decoration: none;">View Quality Report</a></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                        
                                    <!-- Action Buttons -->
                                    <div class="actions">
                                        <a href="http://185.100.212.76:4040" class="btn btn-success">üåê View Live Website</a>
                                        <a href="#" class="btn btn-primary">üìã View Build Log</a>
                                        <a href="http://185.100.212.76:12345/dashboard?id=Dwinzo_Beta_Website" class="btn btn-secondary">üîç Quality Report</a>
                                    </div>
                        
                                    <!-- Additional Information -->
                                    <div class="notes-section">
                                        <strong>‚ÑπÔ∏è Important Notes:</strong>
                                        <ul>
                                            <li>The application is now live and accessible to users</li>
                                            <li>All Docker containers are running successfully</li>
                                            <li>Code quality analysis has been completed</li>
                                            <li>For any issues, contact the DevOps team immediately</li>
                                        </ul>
                                    </div>
                                </div>
                        
                                <!-- Footer -->
                                <div class="footer">
                                    <div class="footer-content">
                                        <div class="product-manager">This product is managed by <span class="name">Marikannan Sankarraj</span></div>
                                        üìß <a href="mailto:marikannan@hexrfactory.com" style="color: #667eea; text-decoration: none;">marikannan@hexrfactory.com</a><br><br>
                                        
                                        <strong>üõ†Ô∏è Infrastructure Engineering Team</strong><br>
                                        Rithish Samm & Ramkumar P.<br><br>
                                        
                                        <div style="margin-top: 15px; font-size: 13px; color: #9ca3af;">
                                            Need help? Contact our DevOps team for technical support or deployment assistance.
                                        </div>
                                    </div>
                                    
                                    <div class="company-info">
                                        <strong>HEXR FACTORY IMMERSIVE TECH PRIVATE LIMITED</strong><br>
                                        <span style="font-size: 12px; color: #9ca3af;">
                                            ¬© 2025 ‚Ä¢ All rights reserved ‚Ä¢ Innovative solutions for the future
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </body>
                        </html>
                        """,
                    to: "marikannan@hexrfactory.com, vishnu@hexrfactory.com, rithish@hexrfactory.com, jerald@hexrfactory.com, nalvazhuthi@hexrfactory.com, ramkumar@hexrfactory.com, surya@hexrfactory.com",
                    attachLog: true,
                    mimeType: 'text/html',
                    replyTo: "marikannan@hexrfactory.com",
                    from: '$SMTP_CREDENTIALS_USR'
                )
                cleanWs(deleteDirs: true, disableDeferredWipeout: true)
            }
        }
        success {
            powershell '''
                Write-Host "‚úÖ Pipeline completed successfully!"
                Write-Host "Build Number: $env:BUILD_NUMBER"
                Write-Host "Website URL: $env:WEBSITE_URL"
                Write-Host "Triggered by: $env:author"
            '''
        }
        failure {
            powershell '''
                Write-Host "‚ùå Pipeline failed!"
                Write-Host "Check logs for details"
                Write-Host "Build Number: $env:BUILD_NUMBER"
                Write-Host "Container status:"
                docker ps -a
            '''
        }
    }
}    